<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <title>Smart Panel Middleware</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <img src="logo.jpeg" alt="Smart Panel" class="logo-img">
        <h1>Smart Panel Middleware</h1>
      </div>
      <span class="version" id="version">v0.1.0</span>
    </header>

    <!-- Update Banner -->
    <div class="update-banner" id="update-banner" style="display: none;">
      <div class="update-top">
        <span class="update-text" id="update-text"></span>
        <div class="update-actions" id="update-actions">
          <button class="btn-update" id="btn-update-download">Update</button>
          <button class="btn-update-dismiss" id="btn-update-dismiss">&times;</button>
        </div>
      </div>
      <div class="update-progress" id="update-progress" style="display: none;">
        <div class="update-progress-bar" id="update-progress-bar"></div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
      <button class="nav-btn active" data-tab="status">Status</button>
      <button class="nav-btn" data-tab="config">Configuration</button>
      <button class="nav-btn" data-tab="logs">Logs</button>
    </nav>

    <!-- Content -->
    <main class="content">
      <!-- Status Tab -->
      <section class="tab-content active" id="tab-status">
        <div class="status-grid">
          <!-- Smart Panel Connection -->
          <div class="status-card">
            <div class="status-header">
              <span class="status-icon">‚òÅÔ∏è</span>
              <h3>Smart Panel Cloud</h3>
            </div>
            <div class="status-indicator disconnected" id="status-smartpanel">
              <span class="dot"></span>
              <span class="text">Disconnected</span>
            </div>
            <p class="status-detail" id="detail-smartpanel">API key not configured</p>
          </div>

          <!-- OBS Connection -->
          <div class="status-card">
            <div class="status-header">
              <span class="status-icon">üé¨</span>
              <h3>OBS Studio</h3>
            </div>
            <div class="status-indicator disconnected" id="status-obs">
              <span class="dot"></span>
              <span class="text">Disabled</span>
            </div>
            <p class="status-detail" id="detail-obs">Enable in configuration</p>
          </div>

          <!-- vMix Connection -->
          <div class="status-card">
            <div class="status-header">
              <span class="status-icon">üé•</span>
              <h3>vMix</h3>
            </div>
            <div class="status-indicator disconnected" id="status-vmix">
              <span class="dot"></span>
              <span class="text">Disabled</span>
            </div>
            <p class="status-detail" id="detail-vmix">Enable in configuration</p>
          </div>
        </div>

        <!-- First Run Message -->
        <div class="first-run-message" id="first-run-message" style="display: none;">
          <h2>üëã Welcome to Smart Panel Middleware!</h2>
          <p>To get started, you need to configure your API Key.</p>
          <ol>
            <li>Go to <a href="#" id="link-api-keys">smart-panel.app/integrations</a> and generate a key</li>
            <li>Go to the <strong>Configuration</strong> tab</li>
            <li>Paste your API Key and click <strong>Verify</strong></li>
          </ol>
        </div>
      </section>

      <!-- Configuration Tab -->
      <section class="tab-content" id="tab-config">
        <form id="config-form">
          <!-- Smart Panel Section -->
          <div class="config-section">
            <h3>‚òÅÔ∏è Smart Panel Cloud</h3>
            <div class="form-group">
              <label for="apiKey">API Key</label>
              <div class="input-with-button">
                <input type="password" id="apiKey" placeholder="sp_XXXXXXXXXXXX">
                <button type="button" class="btn btn-secondary" id="btn-verify-key">Verify</button>
              </div>
              <small>Get your API key from <a href="#" id="link-get-key">smart-panel.app/integrations</a></small>
            </div>
            <div class="api-key-status" id="api-key-status" style="display: none;">
              <span class="status-badge" id="key-status-badge">Valid</span>
              <span class="status-text" id="key-status-text">Connected to company</span>
            </div>
          </div>

          <!-- OBS Section -->
          <div class="config-section">
            <h3>üé¨ OBS Studio</h3>
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" id="obsEnabled">
                Enable OBS integration
              </label>
            </div>
            <div class="obs-settings" id="obs-settings">
              <div class="form-row">
                <div class="form-group">
                  <label for="obsHost">Host</label>
                  <input type="text" id="obsHost" value="localhost">
                </div>
                <div class="form-group">
                  <label for="obsPort">Port</label>
                  <input type="number" id="obsPort" value="4455">
                </div>
              </div>
              <div class="form-group">
                <label for="obsPassword">Password (optional)</label>
                <input type="password" id="obsPassword" placeholder="WebSocket password">
              </div>
              <button type="button" class="btn btn-secondary" id="btn-test-obs">Test Connection</button>
            </div>
          </div>

          <!-- vMix Section -->
          <div class="config-section">
            <h3>üé• vMix</h3>
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" id="vmixEnabled">
                Enable vMix integration
              </label>
            </div>
            <div class="vmix-settings" id="vmix-settings">
              <div class="form-row">
                <div class="form-group">
                  <label for="vmixHost">Host</label>
                  <input type="text" id="vmixHost" value="localhost">
                </div>
                <div class="form-group">
                  <label for="vmixHttpPort">HTTP Port</label>
                  <input type="number" id="vmixHttpPort" value="8088">
                </div>
                <div class="form-group">
                  <label for="vmixTcpPort">TCP Port</label>
                  <input type="number" id="vmixTcpPort" value="8099">
                </div>
              </div>
              <button type="button" class="btn btn-secondary" id="btn-test-vmix">Test Connection</button>
            </div>
          </div>

          <!-- Service Mode Section -->
          <div class="config-section">
            <h3>‚öôÔ∏è Service Mode</h3>
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" id="runAsService">
                Run as background service
              </label>
              <small>When enabled, closing the window minimizes to system tray instead of quitting</small>
            </div>
          </div>

          <!-- Save Button -->
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="btn-save">Save Configuration</button>
            <span class="save-status" id="save-status"></span>
          </div>
        </form>
      </section>

      <!-- Logs Tab -->
      <section class="tab-content" id="tab-logs">
        <div class="logs-header">
          <h3>üìã Recent Logs</h3>
          <button class="btn btn-secondary" id="btn-refresh-logs">Refresh</button>
        </div>
        <div class="logs-path" id="logs-path">Loading...</div>
        <pre class="logs-container" id="logs-container">Loading logs...</pre>
      </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <span>Smart Panel Middleware ¬© 2024</span>
      <a href="#" id="link-help">Help</a>
    </footer>
  </div>

  <script>
    // Tab navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    // Initialize app
    async function init() {
      // Get version
      const version = await window.electronAPI.getVersion();
      document.getElementById('version').textContent = 'v' + version;

      // Check first run
      const isFirstRun = await window.electronAPI.isFirstRun();
      if (isFirstRun) {
        document.getElementById('first-run-message').style.display = 'block';
      }

      // Load config
      await loadConfig();

      // Load logs path
      const logsPath = await window.electronAPI.getLogsPath();
      document.getElementById('logs-path').textContent = 'Logs: ' + logsPath;

      // Load logs
      await refreshLogs();

      // Update status cards
      updateStatus();

      // Listen for auto-connect events
      window.electronAPI.onApiConnected((data) => {
        console.log('API auto-connected:', data);
        updateStatus();
      });

      // Listen for suspend events
      window.electronAPI.onApiSuspended((data) => {
        console.log('API suspended:', data);
        showSuspendedStatus(data.reason);
      });

      window.electronAPI.onApiSuspendChanged((data) => {
        console.log('API suspend changed:', data);
        if (data.suspended) {
          showSuspendedStatus(data.reason, data.message);
        } else {
          hideSuspendedStatus();
          updateStatus();
        }
      });

      // Listen for real-time OBS status changes
      window.electronAPI.onOBSStatusChanged((status) => {
        console.log('OBS status changed:', status);
        updateOBSStatus(status);
      });

      // Listen for real-time vMix status changes
      window.electronAPI.onVMixStatusChanged((status) => {
        console.log('vMix status changed:', status);
        updateVMixStatus(status);
      });

      // Listen for update notifications (from GitHub check or admin push)
      window.electronAPI.onUpdateStatus((status) => {
        const banner = document.getElementById('update-banner');
        const text = document.getElementById('update-text');
        const actions = document.getElementById('update-actions');
        const downloadBtn = document.getElementById('btn-update-download');
        const dismissBtn = document.getElementById('btn-update-dismiss');
        const progress = document.getElementById('update-progress');
        const progressBar = document.getElementById('update-progress-bar');

        switch (status.status) {
          case 'available': {
            let msg = 'New version v' + status.version + ' available!';
            if (status.message) msg += ' ‚Äî ' + status.message;
            text.textContent = msg;
            actions.style.display = 'flex';
            progress.style.display = 'none';

            downloadBtn.textContent = 'Update';
            downloadBtn.disabled = false;
            downloadBtn.onclick = () => {
              window.electronAPI.downloadAndInstall();
            };

            if (status.required) {
              banner.className = 'update-banner update-required';
              dismissBtn.style.display = 'none';
            } else {
              banner.className = 'update-banner';
              dismissBtn.style.display = '';
            }
            banner.style.display = '';
            break;
          }
          case 'downloading':
            text.textContent = 'Downloading update... ' + (status.progress || 0) + '%';
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Downloading...';
            progress.style.display = '';
            progressBar.style.width = (status.progress || 0) + '%';
            break;
          case 'downloaded':
            text.textContent = 'Update downloaded! Installing...';
            actions.style.display = 'none';
            progress.style.display = 'none';
            break;
          case 'error':
            text.textContent = 'Update failed: ' + status.error;
            downloadBtn.textContent = 'Retry';
            downloadBtn.disabled = false;
            downloadBtn.onclick = () => {
              window.electronAPI.downloadAndInstall();
            };
            progress.style.display = 'none';
            break;
        }
      });

      document.getElementById('btn-update-dismiss').addEventListener('click', () => {
        document.getElementById('update-banner').style.display = 'none';
      });

      // Refresh status periodically (every 5 seconds)
      setInterval(updateStatus, 5000);

      // Auto-refresh logs every 5 seconds
      setInterval(refreshLogs, 5000);
    }

    async function loadConfig() {
      const config = await window.electronAPI.getConfig();

      // Smart Panel - only API Key now
      document.getElementById('apiKey').value = config.smartPanel.apiKey || '';

      // OBS
      document.getElementById('obsEnabled').checked = config.obs?.enabled || false;
      document.getElementById('obsHost').value = config.obs?.host || 'localhost';
      document.getElementById('obsPort').value = config.obs?.port || 4455;
      document.getElementById('obsPassword').value = config.obs?.password || '';
      toggleObsSettings();

      // vMix
      document.getElementById('vmixEnabled').checked = config.vmix?.enabled || false;
      document.getElementById('vmixHost').value = config.vmix?.host || 'localhost';
      document.getElementById('vmixHttpPort').value = config.vmix?.httpPort || 8088;
      document.getElementById('vmixTcpPort').value = config.vmix?.tcpPort || 8099;
      toggleVmixSettings();

      // Service Mode
      document.getElementById('runAsService').checked = config.runAsService || false;
    }

    function toggleObsSettings() {
      const enabled = document.getElementById('obsEnabled').checked;
      document.getElementById('obs-settings').style.display = enabled ? 'block' : 'none';
    }

    function toggleVmixSettings() {
      const enabled = document.getElementById('vmixEnabled').checked;
      document.getElementById('vmix-settings').style.display = enabled ? 'block' : 'none';
    }

    function getSuspendReasonText(reason) {
      const reasons = {
        'disabled_by_user': 'Disabled by administrator',
        'disabled_by_platform': 'Disabled by platform',
        'admin_suspended': 'Suspended by admin',
        'quota_exceeded': 'Middleware quota exceeded',
        'subscription_expired': 'Subscription expired',
        'payment_failed': 'Payment failed'
      };
      return reasons[reason] || reason || 'Disabled';
    }

    function showSuspendedStatus(reason, message) {
      const spStatus = document.getElementById('status-smartpanel');
      const spDetail = document.getElementById('detail-smartpanel');

      spStatus.className = 'status-indicator suspended';
      spStatus.querySelector('.text').textContent = 'Suspended';
      spDetail.textContent = message || getSuspendReasonText(reason);
      spDetail.style.color = '#ff6b6b';
    }

    function hideSuspendedStatus() {
      const spDetail = document.getElementById('detail-smartpanel');
      spDetail.style.color = '';
    }

    // Real-time OBS status update (called from event listener)
    function updateOBSStatus(status) {
      const obsStatusEl = document.getElementById('status-obs');
      const obsDetail = document.getElementById('detail-obs');

      if (status.connected) {
        obsStatusEl.className = 'status-indicator connected';
        obsStatusEl.querySelector('.text').textContent = 'Connected';
        obsDetail.textContent = `OBS ${status.version || ''} - ${status.host || 'localhost'}:${status.port || 4455}`;
      } else {
        obsStatusEl.className = 'status-indicator disconnected';
        obsStatusEl.querySelector('.text').textContent = 'Disconnected';
        obsDetail.textContent = 'Connection lost - will auto-reconnect';
      }
    }

    // Real-time vMix status update (called from event listener)
    function updateVMixStatus(status) {
      const vmixStatusEl = document.getElementById('status-vmix');
      const vmixDetail = document.getElementById('detail-vmix');

      if (status.connected) {
        vmixStatusEl.className = 'status-indicator connected';
        vmixStatusEl.querySelector('.text').textContent = 'Connected';
        vmixDetail.textContent = `vMix ${status.version || ''} - ${status.host || 'localhost'}:${status.port || 8088}`;
      } else {
        vmixStatusEl.className = 'status-indicator disconnected';
        vmixStatusEl.querySelector('.text').textContent = 'Disconnected';
        vmixDetail.textContent = 'Connection lost';
      }
    }

    async function updateStatus() {
      const config = await window.electronAPI.getConfig();

      // Smart Panel status - check actual connection
      const spStatus = document.getElementById('status-smartpanel');
      const spDetail = document.getElementById('detail-smartpanel');
      const connStatus = await window.electronAPI.getConnectionStatus();

      if (connStatus.connected) {
        spStatus.className = 'status-indicator connected';
        spStatus.querySelector('.text').textContent = 'Connected';
        spDetail.textContent = connStatus.name || 'Connected to Smart Panel';
      } else if (config.smartPanel.apiKey) {
        spStatus.className = 'status-indicator connecting';
        spStatus.querySelector('.text').textContent = 'Connecting...';
        spDetail.textContent = 'API key configured';
      } else {
        spStatus.className = 'status-indicator disconnected';
        spStatus.querySelector('.text').textContent = 'Not configured';
        spDetail.textContent = 'Add API key in Configuration';
      }

      // OBS status - check actual connection
      const obsStatus = document.getElementById('status-obs');
      const obsDetail = document.getElementById('detail-obs');
      if (config.obs?.enabled) {
        const obsConn = await window.electronAPI.getOBSStatus();
        if (obsConn.connected) {
          obsStatus.className = 'status-indicator connected';
          obsStatus.querySelector('.text').textContent = 'Connected';
          obsDetail.textContent = `OBS ${obsConn.version || ''} - ${config.obs.host}:${config.obs.port}`;
        } else {
          obsStatus.className = 'status-indicator connecting';
          obsStatus.querySelector('.text').textContent = 'Connecting...';
          obsDetail.textContent = config.obs.host + ':' + config.obs.port;
        }
      } else {
        obsStatus.className = 'status-indicator disconnected';
        obsStatus.querySelector('.text').textContent = 'Disabled';
        obsDetail.textContent = 'Enable in Configuration';
      }

      // vMix status - check actual connection
      const vmixStatus = document.getElementById('status-vmix');
      const vmixDetail = document.getElementById('detail-vmix');
      if (config.vmix?.enabled) {
        const vmixConn = await window.electronAPI.getVMixStatus();
        if (vmixConn.connected) {
          vmixStatus.className = 'status-indicator connected';
          vmixStatus.querySelector('.text').textContent = 'Connected';
          vmixDetail.textContent = `vMix ${vmixConn.version || ''} - ${config.vmix.host}:${config.vmix.httpPort}`;
        } else {
          vmixStatus.className = 'status-indicator connecting';
          vmixStatus.querySelector('.text').textContent = 'Connecting...';
          vmixDetail.textContent = config.vmix.host + ':' + config.vmix.httpPort;
        }
      } else {
        vmixStatus.className = 'status-indicator disconnected';
        vmixStatus.querySelector('.text').textContent = 'Disabled';
        vmixDetail.textContent = 'Enable in Configuration';
      }
    }

    async function refreshLogs() {
      const logs = await window.electronAPI.getRecentLogs(100);
      document.getElementById('logs-container').textContent = logs.join('\n');
      // Auto-scroll to top (newest logs first)
      const container = document.getElementById('logs-container');
      container.scrollTop = 0;
    }

    // Event listeners
    document.getElementById('obsEnabled').addEventListener('change', toggleObsSettings);
    document.getElementById('vmixEnabled').addEventListener('change', toggleVmixSettings);
    document.getElementById('btn-refresh-logs').addEventListener('click', refreshLogs);

    // External links
    document.getElementById('link-api-keys').addEventListener('click', (e) => {
      e.preventDefault();
      window.electronAPI.openExternal('https://smart-panel.app/integrations');
    });
    document.getElementById('link-get-key').addEventListener('click', (e) => {
      e.preventDefault();
      window.electronAPI.openExternal('https://smart-panel.app/integrations');
    });
    document.getElementById('link-help').addEventListener('click', (e) => {
      e.preventDefault();
      window.electronAPI.openExternal('https://smart-panel.app/help');
    });

    // Verify API Key
    document.getElementById('btn-verify-key').addEventListener('click', async () => {
      const btn = document.getElementById('btn-verify-key');
      const apiKey = document.getElementById('apiKey').value.trim();
      const statusDiv = document.getElementById('api-key-status');
      const statusBadge = document.getElementById('key-status-badge');
      const statusText = document.getElementById('key-status-text');

      if (!apiKey) {
        statusDiv.style.display = 'block';
        statusBadge.className = 'status-badge error';
        statusBadge.textContent = 'Error';
        statusText.textContent = 'Please enter an API key';
        return;
      }

      btn.textContent = 'Verifying...';
      btn.disabled = true;

      const result = await window.electronAPI.verifyApiKey(apiKey);

      statusDiv.style.display = 'block';

      if (result.valid) {
        if (result.suspended) {
          statusBadge.className = 'status-badge warning';
          statusBadge.textContent = 'Suspended';
          statusText.textContent = getSuspendReasonText(result.suspend_reason);
          btn.textContent = '‚ö† Suspended';
          showSuspendedStatus(result.suspend_reason);
        } else {
          statusBadge.className = 'status-badge success';
          statusBadge.textContent = 'Valid';
          statusText.textContent = result.name ? `Connected: ${result.name}` : 'Connected successfully';
          btn.textContent = '‚úì Verified';
          hideSuspendedStatus();
        }
      } else {
        statusBadge.className = 'status-badge error';
        statusBadge.textContent = 'Invalid';
        statusText.textContent = result.error || 'Could not verify key';
        btn.textContent = 'Verify';
      }

      btn.disabled = false;
      setTimeout(() => { btn.textContent = 'Verify'; }, 3000);
    });

    // Test connections
    document.getElementById('btn-test-obs').addEventListener('click', async () => {
      const btn = document.getElementById('btn-test-obs');
      btn.textContent = 'Testing...';
      btn.disabled = true;

      const result = await window.electronAPI.testOBSConnection({
        host: document.getElementById('obsHost').value,
        port: parseInt(document.getElementById('obsPort').value),
        password: document.getElementById('obsPassword').value
      });

      btn.textContent = result.success ? '‚úì Connected!' : '‚úó ' + result.error;
      btn.disabled = false;
      setTimeout(() => { btn.textContent = 'Test Connection'; }, 3000);
    });

    document.getElementById('btn-test-vmix').addEventListener('click', async () => {
      const btn = document.getElementById('btn-test-vmix');
      btn.textContent = 'Testing...';
      btn.disabled = true;

      const result = await window.electronAPI.testVMixConnection({
        host: document.getElementById('vmixHost').value,
        port: parseInt(document.getElementById('vmixHttpPort').value)
      });

      btn.textContent = result.success ? '‚úì Connected!' : '‚úó ' + result.error;
      btn.disabled = false;
      setTimeout(() => { btn.textContent = 'Test Connection'; }, 3000);
    });

    // Save config
    document.getElementById('config-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const saveBtn = document.getElementById('btn-save');
      const saveStatus = document.getElementById('save-status');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      const updates = {
        smartPanel: {
          apiKey: document.getElementById('apiKey').value
        },
        obs: {
          enabled: document.getElementById('obsEnabled').checked,
          host: document.getElementById('obsHost').value,
          port: parseInt(document.getElementById('obsPort').value),
          password: document.getElementById('obsPassword').value
        },
        vmix: {
          enabled: document.getElementById('vmixEnabled').checked,
          host: document.getElementById('vmixHost').value,
          httpPort: parseInt(document.getElementById('vmixHttpPort').value),
          tcpPort: parseInt(document.getElementById('vmixTcpPort').value)
        },
        runAsService: document.getElementById('runAsService').checked
      };

      const success = await window.electronAPI.saveConfig(updates);

      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Configuration';
      saveStatus.textContent = success ? '‚úì Saved!' : '‚úó Error saving';
      saveStatus.className = 'save-status ' + (success ? 'success' : 'error');

      if (success) {
        document.getElementById('first-run-message').style.display = 'none';
        updateStatus();
      }

      setTimeout(() => { saveStatus.textContent = ''; }, 3000);
    });

    // Start app
    init();
  </script>
</body>
</html>
